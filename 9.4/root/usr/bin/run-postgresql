#!/bin/bash

export ENABLE_REPLICATION=${ENABLE_REPLICATION:-false}

set -eu
export_vars=$(cgroup-limits) ; export $export_vars

source "${CONTAINER_SCRIPTS_PATH}/common.sh"

set_pgdata
check_env_vars
generate_passwd_file
generate_postgresql_config

if [ ! -f "$PGDATA/status/1.initialize_database_done" ]; then
  find $PGDATA -mindepth 1 -delete
  initialize_database
  mkdir -p $PGDATA/status/
  touch $PGDATA/status/1.initialize_database_done
fi

pg_ctl -w start -o "-h ''"
if [ ! -f "$PGDATA/status/2.create_users_done" ]; then
  create_users
  touch $PGDATA/status/2.create_users_done
fi
if [ ! -f "$PGDATA/status/3.set_passwords_done" ]; then
  set_passwords
  touch $PGDATA/status/3.set_passwords_done
fi
pg_ctl stop

unset_env_vars
exec postgres "$@"
