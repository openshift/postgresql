#!/bin/bash

set -eu
export_vars=$(cgroup-limits) ; export $export_vars

source "${CONTAINER_SCRIPTS_PATH}/common.sh"

set_pgdata
check_env_vars
generate_passwd_file
generate_postgresql_config

if [ ! -f "$PGDATA/postgresql.conf" ]; then
  initialize_database
  NEED_TO_CREATE_USERS=yes
fi

pg_ctl -w start -o "-h ''"
if [ "${NEED_TO_CREATE_USERS:-}" == "yes" ]; then
  create_users
fi
set_passwords

if [ -x ${CONTAINER_SCRIPTS_PATH}/hooks.d/post-init ]; then
  # Execute post-init script
  log_info 'Executing post-init ...'
  ${CONTAINER_SCRIPTS_PATH}/hooks.d/post-init
fi

pg_ctl stop
unset_env_vars
exec postgres "$@"
